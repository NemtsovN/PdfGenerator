# PdfGenerator

- [PdfGenerator](#pdfgenerator)
  - [General](#general)
  - [Investigation](#investigation)
    - [Investigated tools](#investigated-tools)
    - [Comparison Table](#comparison-table)
    - [Prototypes](#prototypes)
      - [Performance and development](#performance-and-development)
        - [Performance testing on different HTML sizes](#performance-testing-on-different-html-sizes)
          - [PuppeteerSharp PDF file size optimization](#puppeteersharp-pdf-file-size-optimization)
      - [Correctness of generated PDF styling](#correctness-of-generated-pdf-styling)
  - [Summary](#summary)

## General

Repository for a source code and documentation of PDF documents generation investigation.

## Investigation

> You can find detailed information about every investigated tool in [special folder.](/investigation/)

### Investigated tools

> Please note: final comparison table will include only tools that were not rejected during investigation.

- .NET
  - :white_check_mark: [SelectPDF](https://selectpdf.com/)
  - :x: [PdfSharp](https://github.com/empira/PDFsharp) - it is in preview and requires some custom code or extension to perform transformation of HTML to PDF (community-proposed extension HtmlRenderer is not maintained anymore).
  - :white_check_mark: [IronPdf](https://ironpdf.com/)
  - :x: [DinkToPdf](https://github.com/rdvojmoc/DinkToPdf) - the package is outdated: latest update 18.2017.
  - :white_check_mark: [iTextSharp](https://github.com/itext/itextsharp)
  - :x: [wkhtmltopdf](https://wkhtmltopdf.org/) - CLI that requires us to start additional process on a host. Besides there is a dependency on Qt WebKit.
  - :x: [PDFSharpCore](https://github.com/ststeiger/PdfSharpCore) - community-driven fork of PDFSharp that was transferred to a .NET Core. As well as the original library requires additional functionality to perform transformation.
  - :white_check_mark: [Syncfusion](https://www.syncfusion.com/document-processing/pdf-framework/net/html-to-pdf)
  - :white_check_mark: [DynamicPDF](https://www.dynamicpdf.com/)
  - :white_check_mark: [PuppeteerSharp](https://github.com/hardkoded/puppeteer-sharp)
  - :x: [NReco](https://www.nrecosite.com/pdf_generator_net.aspx) - paid wrapper library for wkhtmltopdf. Requires CLI tool to present on a machine.
- Node.js
  - :x: [Puppeteer](https://github.com/puppeteer/puppeteer) - depends on a headless browser. As there is a .NET implementation, this librariry will not be considered further.
  - :x: [html2pdf.js](https://github.com/eKoopmans/html2pdf.js) - fully client-side library.
  - :x: [jsPDF](https://parall.ax/products/jspdf) - good for transformation of HTML to PDF on a client-side as it requires DOM. Does not work on a backend, with no complex implementation of virtual DOM or headless browser.
  - :x: [html-pdf](https://github.com/marcbachmann/node-html-pdf) - package is deprecated.
  - :x: [pdfkit](https://pdfkit.org/) - good package for building PDF and not generation based on HTML. To generate PDF from HTML requies additional packages and the most popular is html-pdf.
- Python
  - :white_check_mark: [Weasyprint](https://weasyprint.org/)

### Comparison Table

We have selected a set of tools that do not have major concerns and seemed suitable for further investigation.

| Feature                              | SelectPDF                                                                                                                              | IronPDF                                                                                                         | iTextSharp                                                                                                | Syncfusion                                                                                                                                                                                                                                                        | DynamicPDF                                                                                                                                           | PuppeteerSharp                                                                     | Weasyprint                                                                                                        |
|--------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------|
| PDF generation based on HTML markup. | From a string, URL or a file.                                                                                                          | From a string, URL or a file.                                                                                   | From a string, file and Stream.                                                                           | From a string, file and Stream.                                                                                                                                                                                                                                   | From a string or URL.                                                                                                                                | From a URL, file or string.                                                        | From URL, file or string                                                                                          |
| Result PDF storage.                  | Stream or file.                                                                                                                        | Stream or file.                                                                                                 | Stream or file.                                                                                           | Stream or file.                                                                                                                                                                                                                                                   | Byte array.                                                                                                                                          | Stream, byte array or file                                                         | string or file.                                                                                                   |
| Features                             | [Feature list](https://selectpdf.com/pdf-library-for-net/)                                                                             | [Feature list](https://ironpdf.com/features/#html-file-to-pdf)                                                  | [Feature list](https://itextpdf.com/products/itext-7/convert-html-css-to-pdf-pdfhtml)                     | [Feature list](https://help.syncfusion.com/file-formats/pdf/overview#key-features-of-essential-pdf)                                                                                                                                                               | [Feature list](https://www.dynamicpdf.com/examples/dynamic-pdf-core-suite-generator-merger-reportwriter-.net)                                        | Features are limited. [Feature list](http://www.puppeteersharp.com/api/index.html) | Features are limited. [Feature list](https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#quickstart) |
| Platform                             | Windows                                                                                                                                | Any Platform                                                                                                    | Any Platform (assumption is based on a fact that no documentation found that would specify limitation)    | Any platform. Requires specific Nuget package per environment due to a dependency on a Blink.                                                                                                                                                                     | Any system.                                                                                                                                          | Any system.                                                                        | Any system                                                                                                        |
| License                              | Commercial license: 499$-1599$ per 1 year. Community - available for commercial purposes but is limited with 5 pages in a document.    | Commercial license: 749$ - 2999$ per 1 year.                                                                    | Request is sent to product team                                                                           | 395$ per month per 5 developers. 695$ per month per 10 developers. More than 10 developers - should be discussed with sales. There are licenses per application, [but should be discussed with sales as well](https://www.syncfusion.com/sales/unlimitedlicense). | 449$ per developer per year. There is an option for perpetual license that includes minor/major updates during the first year. 879$ per 1 developer. | Free (MIT license)                                                                 | Free (BSD-3 license)                                                                                              |
| Open-source                          | No                                                                                                                                     | No                                                                                                              | Yes                                                                                                       | No                                                                                                                                                                                                                                                                | No                                                                                                                                                   | Yes                                                                                | Yes                                                                                                               |
| Community activity                   | 237 search results on StackOverflow                                                                                                    | 211 search results on StackOverflow                                                                             | 1.3k starts on a GitHub. 500 search results on StackOverflow                                              | No possibility to identify the amount of StackOverflow questions due to variety of tools provided by company.                                                                                                                                                     | Approximately 120 results on a StackOverflow.                                                                                                        | Approximately 180 results on a StackOverflow.                                      | Approximately 500 results on a StackOverflow.                                                                     |
| Update frequency                     | Development is active, new version approximately every 3 month. The latest version has been published on 08/062023.                    | Active development. New version approximately every month. The latest version has been published on 02/06/2023. | Partially active development. New version approximately every 3-5 month. The latest release on 10/05/2023 | Active development. New version every 1-2 weeks. The latest release on 13/06/2023.                                                                                                                                                                                | Partially active development. New version every 2-4 month. The latest release on 01/06/2023.                                                         | Active development. New release every 2-3 month. The latest release on 05/05/2023  | Active development. New release every 2-3 weeks. The latest release on 11/05/2023                                 |
| Number of downloads                  | 2.7 million.                                                                                                                           | 6.2 million.                                                                                                    | 4.2 million.                                                                                              | Total downloads (for every type of OS package): 23 9879                                                                                                                                                                                                           | 109.9K downloads                                                                                                                                     | 7.1M downloads                                                                     | No possibility to verify.                                                                                         |
| Overall rating                       | :star: :star:                                                                                                                          | :star: :star: :star:                                                                                            | :star: :star: :star: :star:                                                                               | :star: :star: :star:                                                                                                                                                                                                                                              | :star: :star: :star:                                                                                                                                 | :star: :star: :star: :star:                                                        | :star: :star: :star: :star:                                                                                       |

### Prototypes

Based on a comparison table, we have decided to perform further investigation and prototyping.

A list of selected tools contain:

- [iText](https://itextpdf.com/products/itext-7/convert-html-css-to-pdf-pdfhtml). According to a comparison table this is one of the most advanced tools for PDF generation.
- [NReco](https://www.nrecosite.com/pdf_generator_net.aspx). A .NET wrapper for wkhtmltopdf CLI tool. It is partially opposite of web browser based approaches and is very popular itself. Due these facts, we decided that it can be a good candidate for prototype.
- [PuppeteerSharp](https://www.puppeteersharp.com/). One of the most popular approaches, with a great community. Open-source and free.
- Custom wapper for [wkhtmltopdf](https://wkhtmltopdf.org/). Our own implementation of a wrapper provided in different libraries. It is a good candidate to estimate performance of tool as well as perform further investigations.
- [Weasyprint](https://weasyprint.org/). Python based tooling that is open-source and has a great community.

For each of these tools, we have created a [prototype](/prototypes/) and performed benchmark to get main metrics. Besides benchmarking we will also estimate documentation and development effort to implement code.

#### Performance and development

> Benchmarking has been performed on [HTML inputs](/prototypes/PdfGenerator.Prototypes/benchmarks/Benchmarks/Stubs).

| Feature                                                                    | PuppeteerSharp                                                                                                                                                                                   | iText                                                                                                                                                                                                                                                                                                                                                         | Wkhtmltopdf wrapper                                                                                                                                                | NReco                                                                                                                                                      | Weasyprint                                                         |
|----------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------|
| Mean time to generate PDF from HTML                                        | 628.06 ms                                                                                                                                                                                        | 74.31 ms                                                                                                                                                                                                                                                                                                                                                      | 1,194.24 ms                                                                                                                                                        | 1,162.65 ms                                                                                                                                                | 585.00 ms.                                                         |
| Allocated memory by application                                            | 3639.39 KB                                                                                                                                                                                       | 48698.01 KB                                                                                                                                                                                                                                                                                                                                                   | 220.15 KB                                                                                                                                                          | 142.63 KB                                                                                                                                                  | 79100 KB                                                           |
| Allocated memory by Docker container (including application)               | ≈48340  KB                                                                                                                                                                                       | ≈83000 KB                                                                                                                                                                                                                                                                                                                                                     | ≈80740 KB                                                                                                                                                          | ≈10650 KB                                                                                                                                                  | N/A                                                                |
| Development effort                                                         | Medium effort. It is required to prepare Chromium browser that will be used during generation. It can be downloaded in code, but in future it should be prepared before running the application. | Minimal effort. Transformation code is easy to read and modify.                                                                                                                                                                                                                                                                                               | Maximum effort. We had to setup separate process as well as configure CLI arguments and read the output.                                                           | Minimal effort.                                                                                                                                            | Minimal effort.                                                    |
| Testing potential                                                          | Weak potential for unit testing. At the same time, e2e-testing can be performed. The only thing to keep in mind is availability of Chromium in automated pipeline.                               | No interfaces provided by library, so unit testing can be complex. Complex types of testing seem possible due to independency of a solution.                                                                                                                                                                                                                  | Potentially possible to perform unit testing as all types are .NET common. Complex types of testing can be non-trivial as would require CLI on a pipeline machine. | No interfaces provided by library, so unit testing can be complex. Complex types of testing can be non-trivial as would require CLI on a pipeline machine. | No team experience in Python code unit testing.                    |
| Documentation quality                                                      | Detailed documentation as well as interfaces definition.                                                                                                                                         | Documentation is not enough detailed, complex examples are missing. Github issues are not available. Interfaces definition is available as well as developer portal with asked questions (but the amount of questions is small).                                                                                                                              | Documentation is detailed and well defined. GitHub issues are available as well as CLI definition.                                                                 | Minimal documentation that is limited with the only one page. Interface definitions are available.                                                         | Rich documentation. GitHub issues are available.                   |
| Community support                                                          | 2.7K stars on GitHub. Great amount of articles as well as community support via GitHub issues.                                                                                                   | 1.7K for main library and 139 starts for pdftohtml addon on GitHub. Community forum that makes possible to iText developers to answer questions in a form of articles. There is no information about answering speed and the amount of questions/answers is limited. No other community support except of general-purpose forums (as StackOverflow) is found. | Great community support for a based Wkhtmltopdf library. Available GitHub issues and dedicated articles.                                                           | No real community support as the solution is not open-source.                                                                                              | 5.9K stars on GitHub. Rich community support.                      |
| Deployment complexity                                                      | High. Requires an approach that will speed up downloading of headless web browser. It can be baked in EC2 instance or can be delivered through a Lambda Layers.                                  | Low. Seems to bring no additional tools, so should be possible to deploy just as a Nuget that is restored.                                                                                                                                                                                                                                                    | High. Requires CLI tool to present on a machine. It can be baked in EC2 instance or can be delivered through a Lambda Layers.                                      | High. Requires CLI tool to present on a machine. It can be baked in EC2 instance or can be delivered through a Lambda Layers.                              | Minimal. Requires Python pipeline and dependencies installed only. |

##### Performance testing on different HTML sizes

> Testing has been performed inside Docker container.

| Prototype           | Input HTML size | Resulting PDF size | Memory consumed | Time consumed |
|---------------------|-----------------|--------------------|-----------------|---------------|
| PuppeteerSharp      | 6 KB            | 303 KB             | Up to 120 MB    | 750-1058 ms   |
| iText               | 6 KB            | 37 KB              | 96 MB           | 4337 ms       |
| NReco               | 6 KB            | 33 KB              | 20 MB           | 850 ms        |
| wkhtmltopdf wrapper | 6 KB            | 27 KB              | 20 MB           | 650 ms        |
| Weasyprint          | 6 KB            | 30 KB              | 80 MB           | 584 ms        |
| PuppeteerSharp      | 30 KB           | 1400 KB            | Up to 211 MB    | 950 ms        |
| iText               | 30 KB           | 66 KB              | 98 MB           | 4675 ms       |
| NReco               | 30 KB           | 76 KB              | 25 MB           | 903 ms        |
| wkhtmltopdf wrapper | 30 KB           | 62 KB              | approx. 20 MB   | 700 ms        |
| Weasyprint          | 30 KB           | 80 KB              | 95.6 MB         | 992 ms        |
| PuppeteerSharp      | 61 KB           | 2800 KB            | Up to 231 MB    | 1100-1500 ms  |
| iText               | 61 KB           | 103 KB             | 103 MB          | 5500 ms       |
| NReco               | 61 KB           | 129 KB             | 32 MB           | 950-1000  ms  |
| wkhtmltopdf wrapper | 61 KB           | 108 KB             | approx. 22 MB   | 750 ms        |
| Weasyprint          | 61 KB           | 143 KB             | 120.7 MB        | 1485 ms       |
| PuppeteerSharp      | 499 KB          | 22 200 KB          | Up to 700 MB    | 3800-4300 ms  |
| iText               | 499 KB          | 632 KB             | 177 MB          | 9200 ms       |
| NReco               | 499 KB          | 886 KB             | 60-100 MB       | 1800 ms       |
| wkhtmltopdf wrapper | 499 KB          | 764 KB             | approx. 48 MB   | 1000-1200 ms  |
| Weasyprint          | 499 KB          | 1100 KB            | 412.1 MB        | 9180 ms       |

###### PuppeteerSharp PDF file size optimization

According investigation, PuppeteerSharp generates PDFs of insane sizes. As we have found out, it is mostly related to the behaviour of custom fonts applying: removing it significantly reduces PDF file size:

| Prototype            | Input HTML size | Resulting PDF size |
|----------------------|-----------------|--------------------|
| PuppeteerSharp       | 499 KB          | 5 900 KB           |
| iText                | 499 KB          | 577 KB             |
| NReco                | 499 KB          | 894 KB             |
| wkhtmltopdf wrapper  | 499 KB          | 774 KB             |

Due this fact, development team should consider **not referencing** styles from HTML files and do optimization practice to avoid insane PDF sizes.

> You can read about this in [GitHub issue](https://github.com/puppeteer/puppeteer/issues/458).

#### Correctness of generated PDF styling

Besides just benchmarking of solutions, we have compared them by functionality:

| Feature                                                    | PuppeteerSharp                                                                                                           | iText                                                                                               | Wkhtmltopdf wrapper                                                                                                   | NReco                                                                                                                 | Weasyprint                                                                   |
|------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------|
| Custom fonts                                               | :white_check_mark:                                                                                                       | :white_check_mark:                                                                                  | :white_check_mark:                                                                                                    | :white_check_mark:                                                                                                    | :white_check_mark:                                                           |
| Image as URL                                               | :white_check_mark:                                                                                                       | :white_check_mark:                                                                                  | :white_check_mark:                                                                                                    | :white_check_mark:                                                                                                    | :white_check_mark:                                                           |
| Image as SVG                                               | :white_check_mark:                                                                                                       | :white_circle: Image has been rendered but with a missing margin.                                   | :white_circle: Image has been rendered but with a missing margin.                                                     | :white_check_mark:                                                                                                    | :white_check_mark:                                                           |
| Tables                                                     | :white_check_mark:                                                                                                       | :white_check_mark:                                                                                  | :white_check_mark:                                                                                                    | :white_check_mark:                                                                                                    | :white_check_mark:                                                           |
| Table headers migration to a next page.                    | :x:                                                                                                                      | :x:                                                                                                 | :x:                                                                                                                   | :x:                                                                                                                   | :x:                                                                          |
| Table row split to a different pages.                      | :white_circle: Can be modified with CSS styling.                                                                         | :white_circle: Automatically generated and can not be controlled.                                   | :white_circle: Can be modified with CSS styling.                                                                      | :white_circle: Can be modified with CSS styling.                                                                      | :white_circle: Automatically generated and can not be controlled.            |
| Lists                                                      | :white_check_mark:                                                                                                       | :white_check_mark:                                                                                  | :white_check_mark:                                                                                                    | :white_check_mark:                                                                                                    | :white_check_mark:                                                           |
| CSS                                                        | :white_check_mark:                                                                                                       | :white_circle: Image has been rendered but with a missing margin.                                   | :white_circle: Image has been rendered but with a missing margin.                                                     | :white_check_mark:                                                                                                    | :white_check_mark:                                                           |
| Background colours                                         | :white_check_mark:                                                                                                       | :x: Inherited from HTML. No modification possible.                                                  | :x: Inherited from HTML. No modification possible.                                                                    | :x: Inherited from HTML. No modification possible.                                                                    | :white_check_mark:                                                           |
| Bold text for custom fonts                                 | :white_check_mark:                                                                                                       | :x:                                                                                                 | :x:                                                                                                                   | :x:                                                                                                                   | :x:                                                                          |
| Header/Footer                                              | :white_circle: Format of date time is based on a language that was in a system. No custom font inside.                   | :white_check_mark: No custom fonts supported.                                                       | :white_check_mark: Requires to create a temporary files that will store HTML footer/header.                           | :white_check_mark: Requires to create a temporary files that will store HTML footer/header.                           | :white_circle: Controller only with a help of HTML and CSS. No custom fonts. |
| Page margins                                               | :white_check_mark:                                                                                                       | :white_circle: No possibility to modify some predefined margins.                                    | :white_circle: No possibility to modify some predefined margins.                                                      | :white_circle: No possibility to modify some predefined margins.                                                      | :white_check_mark:                                                           |
| Page breaks                                                | :white_check_mark:                                                                                                       | :white_circle: Page breaker breaks counter of pages and total pages is different for 1 and 3 pages. | :white_check_mark:                                                                                                    | :white_check_mark:                                                                                                    | :white_check_mark:                                                           |
| Line breaker                                               | :white_check_mark:                                                                                                       | :white_check_mark:                                                                                  | :white_check_mark:                                                                                                    | :white_check_mark:                                                                                                    | :white_check_mark:                                                           |
| Coloured text                                              | :white_check_mark:                                                                                                       | :white_check_mark:                                                                                  | :white_check_mark:                                                                                                    | :white_check_mark:                                                                                                    | :white_check_mark:                                                           |
| Anchor links                                               | :white_check_mark:                                                                                                       | :white_check_mark:                                                                                  | :white_check_mark:                                                                                                    | :white_check_mark:                                                                                                    | :white_check_mark:                                                           |
| HTML elements generated with a help of Javascript on load. | :white_check_mark:                                                                                                       | :x:                                                                                                 | :x:                                                                                                                   | :white_check_mark:                                                                                                    | :x:                                                                          |
| The amount of differences in CSS between HTML and PDF.     | The most elements are rendered as expected. Missed styling elements were fixed with a help of configuration adjustments. | Big amount of differences. Some of them can not be changed during PDF generation.                   | The most elements are rendered as expected. There are elements that can not be adjusted with generator configuration. | The most elements are rendered as expected. There are elements that can not be adjusted with generator configuration. | There are some limitations, but the most elements are transferred correctly. |


## Summary

As a result of investigation, we **can not** highlight any library that is exact winner:

- [PuppeteerSharp](https://github.com/hardkoded/puppeteer-sharp)
  - Pros:
    - .NET solution
    - frequently updated
    - great documentation
    - big community
    - free and open-source
    - the most agile tool that allows to generate complex PDFs
    - there where articles and cases that use this tool in Serverless approach
    - "median" performance
  - Cons:
    - huge result PDF files (potentially can be optimized)
    - not in-memory and requires browser to present on a machine
    - huge amount of memory used during generation of PDF
- [iTextSharp](https://github.com/itext/itextsharp)
  - Pros:
    - .NET solution
    - frequently updated
    - open-source
    - "median" memory consumption
    - as it requires no dependencies, should be possible to use in Serverless
  - Cons:
    - bad documentation
    - not the greatest community
    - has no open GitHub issues which are handy for development experience
    - paid
    - converts PDFs with mistakes and provides no ability to configure tool and resolve that
    - historically a Java library which was ported to .NET (with Java-styled code inside)
    - "bad" performance in comparison with other tooling
- [NReco](https://www.nrecosite.com/pdf_generator_net.aspx)
  - Pros:
    - .NET solution
    - "small" price in comparison to other tooling
    - Nreco is frequently updated (please consider this as wrapper update only)
    - "median" amount of mistakes in styling during PDF generation
    - "good" performance and memory consumption
  - Cons:
    - based on wkhtmltopdf that is not maintained anymore
    - provides developer with a limited interface (actually inherited from wkhtmltopdf)
    - requires CLI tool to present on a machine
- [Weasyprint](https://weasyprint.org/)
  - Pros:
    - frequently updated
    - great documentation
    - big community
    - free and open-source
    - there where articles and cases that use this tool in Serverless approach
  - Cons:
    - performance is more to "bad" in comparison with other tooling
    - Python based solution
    - limitations in transforming HTML to PDF that completely depends on CSS processor and is hard to modify
